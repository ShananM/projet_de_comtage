<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Niveaux de Batterie</title>
  <style>
    table {
      border-collapse: collapse;
      width: 50%;
      margin: 40px auto;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f7f7f7;
    }
    h2 {
      text-align: center;
    }
    .progress-bar-container {
      background-color: #eee;
      border-radius: 5px;
      overflow: hidden;
      height: 20px;
    }
    .progress-bar {
      height: 100%;
      width: 0;
      transition: width 0.5s ease;
    }
    .low {
      background-color: red;
    }
    .medium {
      background-color: orange;
    }
    .high {
      background-color: green;
    }
    .alerte-batterie {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      color: white;
      text-align: center;
      z-index: 9999;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h2>Niveaux de batterie</h2>
  <table>
    <thead>
      <tr>
        <th>R√©cepteur / √âmetteur</th>
        <th>Niveau de batterie</th>
        <th>Jauge</th>
      </tr>
    </thead>
    <tbody id="batterie-table">
      <!-- Rempli dynamiquement -->
    </tbody>
  </table>

  <script>
    const noms = ['R-A', 'R-B', 'R-C', 'E1', 'E2', 'E3', 'E4', 'E5', 'E6'];

    function getBatteryClass(value) {
      if (value < 4.2) return 'low';
      if (value < 8.4) return 'medium';
      return 'high';
    }

    function mettreAJourAffichage(data) {
      let html = '';

      noms.forEach(nom => {
        const valeur = data[nom];
        const niveau = valeur !== undefined ? parseFloat(valeur) : null;

        let niveauAffiche = '-';
        let jaugeHTML = '-';

        if (niveau !== null && !isNaN(niveau)) {
          const classe = getBatteryClass(niveau);
          const pourcentage = Math.min(100, (niveau / 10) * 100); // s√©curit√©
          niveauAffiche = niveau.toFixed(1);

          jaugeHTML = `
            <div class="progress-bar-container">
              <div class="progress-bar ${classe}" style="width: ${pourcentage}%"></div>
            </div>
          `;
        }

        html += `
          <tr>
            <td>${nom}</td>
            <td>${niveauAffiche}</td>
            <td>${jaugeHTML}</td>
          </tr>`;
      });

      document.getElementById('batterie-table').innerHTML = html;
    }

    function afficherAlertes(data) {
      const alertesRouge = [];
      const alertesOrange = [];

      noms.forEach(nom => {
        const niveau = parseFloat(data[nom]);
        if (!isNaN(niveau)) {
          if (niveau < 4.2) alertesRouge.push(nom);
          else if (niveau < 8.4) alertesOrange.push(nom);
        }
      });

      document.querySelectorAll('.alerte-batterie').forEach(el => el.remove());

      let message = '';
      if (alertesRouge.length) message += `üî¥ Batterie CRITIQUE : ${alertesRouge.join(', ')}\n`;
      if (alertesOrange.length) message += `üü† Batterie FAIBLE : ${alertesOrange.join(', ')}`;

      if (message) {
        const div = document.createElement('div');
        div.className = 'alerte-batterie';
        div.textContent = message;
        div.style.backgroundColor = alertesRouge.length ? '#f44336' : '#ff9800';
        document.body.appendChild(div);
      }
    }

    function chargerDonnees() {
      fetch('../alerte.php')
        .then(response => {
          if (!response.ok) throw new Error('Erreur de r√©ponse');
          return response.json();
        })
        .then(data => {
          mettreAJourAffichage(data);
          afficherAlertes(data);
        })
        .catch(error => {
          console.error('Erreur de r√©cup√©ration des donn√©es :', error);
        });
    }

    // Initialisation et mise √† jour p√©riodique
    chargerDonnees();
    setInterval(chargerDonnees, 5000);
  </script>
</body>
</html>
